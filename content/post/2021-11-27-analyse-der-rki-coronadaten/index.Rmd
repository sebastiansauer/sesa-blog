---
title: Analyse der RKI-Coronadaten
author: Sebastian Sauer
date: '2021-11-27'
slug: analyse-der-rki-coronadaten
categories:
  - rstats
tags:
  - covid19
  - tutorial
  - eda
  - regression
output:
  blogdown::html_page:
    toc: yes
    number_sections: yes
editor_options: 
  chunk_output_type: console
---


# Setup


```{r global-knitr-options, include=FALSE}
  knitr::opts_chunk$set(
  fig.pos = 'H',
  fig.asp = 0.618,
  fig.align='center',
  fig.width = 5,
  out.width = "100%",
  fig.cap = "", 
  #fig.path = "chunk-img/",
  dpi = 300,
  # tidy = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  fig.show = "hold")
```

## R-Pakete

```{r include=FALSE}
library(rcrossref)  # zitieren
library(tidyverse)  # Datenjudo
library(rstatix)  # EDA-Komfort
library(forcats)  # Faktorvariablen sortieren
library(tictoc)  # Rechenzeit messen
```



# Hintergrund

Die Corona-Epidemie beherrscht (wieder) die Nachrichten, Gespräche und Gedanken.
Zu Recht, aus zwei Gründen. 
Zum einen sind die Zahlen jetzt schon besorgniserregend, wenn nicht furchtbar.
Zum anderen haben [Pandemien das Potenzial zu krassen Extremwerten](https://www.nature.com/articles/s41567-020-0921-x?report=reader).

Dazu kommt, dass Falschmeldungen kursieren.
Schlimmer noch als reine Unwahrheit sind Halbwahrheiten.
Damit ist die Unsitte gemeint, einen einzelnen, (vielleicht) korrekten Fakt aufzugreifen,
und damit eine vielschichtige Forschungsfrage für beantwortet zu erklären.
Das gleicht dem Versuch, von einem 500-Teile-Puzzle ein Stück gefunden zu haben,
und nun zu reklamieren, man wisse, wie das ganze Puzzle aussieht.
Eher in Forschungsvokablen: Auf Basis einer Studie gibt man vor, 
eine Antwort auf eine breite Forschungsfrage zu geben,
ohne zu erwähnen, dass es noch 50 anders geartete Studien gibt,
die zu (evtl.) anderen Ergebnissen kommen.


Der Vergleich mehrerer Gruppen ist immer problematisch, 
problematisch in dem Maße, wie sich die Gruppen in unbekannter Weise unterscheiden.
So ist es beispielsweise schwierig, 
die Übersterblichkeit in Deutschland in 2020 und 2021 zu vergleichen.
Auf die Übersterblichkeit wirken viele Faktoren ein;
so könnten etwa die Kontaktbeschränkungen dazu geführt haben,
dass die Grippe sich nicht so ausbreiten konnte.
Dadurch wurden Krankheits- und Todesfälle vermieden;
man könnte aber auch (fälschlich) schlussfolgern,
dass Corona doch "nicht so schlimm" gewesen war.
Viele weitere Unterschiede sind denkbar;
etwas Deltavariante vs. den Ursprungsvirus und so weiter.

Der Vergleich zwischen Ländern ist aus dem gleichen Grund noch schwieriger.
Länder unterscheiden sich in vielen Hinsichten;
im Hinblick auf Corona sind vermutlich klimatorische Unterschiede entscheidend.
In einem warmen Land wird - bei gleicher Kontakt- oder Impfsituation -
sicherlich weniger Fälle auftreten als in einem kalten Land.
Das ist nur einer von vielen Unterschieden, 
die eine Rolle spielen können 
und uns zeigen,
warum die Menschen Experimente erfunden haben,
um die Vergleichbarkeit von Gruppen gewährleisten zu können.

Neben der Vergleichbarkeit der Daten spielt natürlich auch die Datenqualität
(neben und über die Vergleichbarkeit der Datenqualität hinaus) eine wichtige Rolle.
In Deutschland leistet das RKI gute Arbeit,
Daten auf möglichst hohem Niveau zu sammeln.
Praktischerweise sind diese Daten auch öffentlich und komfortabel zugänglich.

Im Lichte der bisher (in jüngerer Geschichte) nicht dagewesesen gesundheitlichen 
Gefährdungen durch die Epidemie und auch gesellschaftliche Brisanz ist die Frage
nach den Fakten zu Corona und ihren Auswirkungen von höchstem Belang.

Grund genug, sich die Daten und Analysen zu Corona auf *reproduzierbare* Art und Weise,
also transparent und für alle nachprüfbar, anzuschauen.


# Inzidenzen in Deutschland - Daten vom RKI

Das [Robert-Koch-Institut](https://www.rki.de/DE/Home/homepage_node.html) (RKI) stellt die Daten zu den Corona-Infektionen [hier](https://github.com/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland) öffentlich zum Herunerladen bereit.

Die [CSV-Datei mit den aktuellen Daten](https://github.com/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland/blob/master/Aktuell_Deutschland_SarsCov2_Infektionen.csv) ist groß; 150 MB (26.11.21).


Die Daten werden unter der [CC-BY-Lizenz bereitgestellt vom RKI.](https://github.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland#lizenz)



# Hospitalisierungen in Deutschland

Aufgrund der großen Dateigröße fangen wir mit einer kleineren Datei an.
[Die Datei mit den Hospitalisierungen](https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland) ist viel kleiner (3MB).

Es wird auch ein adjustierter Datensatz bereitgestellt:

>   Zwischen dem Beginn des Krankenhausaufenthalts eines COVID-19-Falles und dem Zeitpunkt, an dem diese Information am RKI eingeht, entsteht ein zeitlicher Verzug. Um den Trend der Anzahl von Hospitalisierungen und der 7-Tage-Hospitalisierungsinzidenz besser bewerten zu können, ergänzen wir die berichtete Hospitalisierungsinzidenz um eine Schätzung der zu erwartenden Anzahl an verzögert berichteten Hospitalisierungen. Neben den Daten der gemeldeten COVID-19-Hospitalisierungen auf Bundes- und Länderebene wird daher ein Nowcasting der Anzahl hospitalisierter Fälle und der 7-Tage-Hospitalisierungsinzidenz auf Bundesebene durchgeführt. Ziel ist die Schätzung der Anzahl von hospitalisierten COVID-19-Fällen mit Meldedatum innerhalb der sieben vorhergehenden Tage - inklusive der noch nicht an das RKI berichteten Hospitalisierungen.

Schauen wir uns den neuesten (adjustierten) Datensatz näher an.


Zur Berechnung der adjustierten 7T-Inzidenz schreibt das RKI [hier](https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland#berechnung-der-adjustierten-7-tage-hospitalisierungsinzidenz):

>   Die adjustierte 7-Tage-Hospitalisierungsinzidenz berechnet sich aus der adjustierten Anzahl der hospitalisierten COVID-19-Fälle der letzten sieben Tage (vorherig des Berichtsdatums) und der Bevölkerungszahl. Zur einheitlichen Darstellung wird die Inzidenz auf 100.000 Bevölkerung normiert.


## Adjustierte Daten

### Daten importieren


```{r}
hosp_file <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/master/Archiv/2021-11-24_Deutschland_adjustierte-COVID-19-Hospitalisierungen.csv"

hosp_adj <- read_csv(hosp_file)  # adj wie "adjustiert"
```


### EDA


```{r}
hosp_adj %>% 
  ggplot() +
  aes(x = Datum, y = PS_adjustierte_7T_Hospitalisierung_Inzidenz) +
  geom_line() 
```


## Unadjustierte Daten

### Daten importieren

```{r}
hosp_latest_file <- "https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/raw/master/Archiv/2021-11-27_Deutschland_COVID-19-Hospitalisierungen.csv"

hosp_latest <- read_csv(hosp_latest_file)
```


### EDA


#### Bundesgebiet

```{r}
hosp_latest %>% 
  filter(Bundesland == "Bundesgebiet") %>% 
  ggplot() +
  aes(x = Datum, y = `7T_Hospitalisierung_Inzidenz`) +
  geom_line(aes(color = Altersgruppe)) +
  scale_color_brewer(type = "qual")
```


#### Nach Bundesland


```{r}
hosp_latest %>% 
  filter(Bundesland != "Bundesgebiet") %>% 
  ggplot() +
  aes(x = Datum, y = `7T_Hospitalisierung_Inzidenz`) +
  geom_line(aes(color = Altersgruppe)) +
  scale_color_brewer(type = "qual") +
  facet_wrap(~ Bundesland)
```


```{r}
hosp_latest %>% 
  filter(Bundesland != "Bundesgebiet") %>% 
  filter(Datum == max(Datum)) %>% 
  select(-Bundesland_Id, -`7T_Hospitalisierung_Faelle`) %>% 
  mutate(Bundesland = factor(Bundesland)) %>% 
  group_by(Bundesland) %>% 
  summarise(Inz_7T_Hosp = mean(`7T_Hospitalisierung_Inzidenz`)) %>% 
  ggplot() +
  aes(y = fct_reorder(Bundesland, Inz_7T_Hosp), x = Inz_7T_Hosp) +
  geom_col()
```



# Impfungen in Deutschland


## Neueste Daten

### Daten laden

Von [diesem Github-Repo](https://github.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland) kann man sich die Impfdaten beim RKI herunterladen.


Die Daten werden sogar pro Landkreis bereitgestellt.
Wir begnügen uns hier aber mit den Daten pro Bundesland.


```{r}
vacc_file_latest <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv/2021-11-27_Deutschland_Impfquoten_COVID-19.csv"

vacc_latest <- read_csv(vacc_file_latest)
```


```{r}
glimpse(vacc_latest)
```


Die Datei gibt die Impfquote für einen Tag (hier 27.11.21) wieder.

### EDA




```{r}
vacc_latest %>% 
  #filter(Bundesland != "Deutschland") %>% 
  mutate(Bundesland = factor(Bundesland)) %>% 
  ggplot() +
  aes(y = fct_reorder(Bundesland, Impfquote_gesamt_voll), 
      x = Impfquote_gesamt_voll) +
  geom_col() +
  labs(title = "Impfquote am 27.11.2021",
       caption = "Datenquelle: RKI")
```



## Impfquoten im Zeitverlauf



### Daten laden 1

```{r}
vacc_time_file <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv/2021-11-24_Deutschland_Bundeslaender_COVID-19-Impfungen.csv"

vacc_time <- read_csv(vacc_time_file)
```



```{r}
glimpse(vacc_time)
```

Diese Datei gibt uns nicht direkt die Impfquoten, sondern die Anzahl der Impfungen pro Bundesland pro Tag. 
Einfacher ist es vielleicht, die Dateien zu suchen, die uns die Impfquoten schon komfortabel zur Verfügung stellen.


### Daten laden 2

#### Relevante Daten finden

Im RKI-Repo finden sich dazu Dateien mit dem Namen `JJJJ-MM-TT_Deutschland_Impfquoten_COVID-19.csv`.

Unser Plan muss wohl sein, alle diese Dateien zusammenzutragen und dann in eine Tabelle (Dataframe) zusammenzufügen.

Da ich das Repo auf meine Festplatte heruntergeladen habe, 
kann ich recht komfortabel eine Liste der relevanten Dateien bekommen:

```{r}
vacc_dir <- "/Users/sebastiansaueruser/github-repos/COVID-19-Impfungen_in_Deutschland/Archiv"

search_term <- "^\\d{4}-\\d{2}-\\d{2}_Deutschland_Impfquoten_COVID-19.csv$"

vacc_time_files <- 
  list.files(path = vacc_dir,
             pattern = search_term)
```


```{r}
head(vacc_time_files)
length(vacc_time_files)
```

Wir haben also Daten von `r length(vacc_time_files)` Daten.


#### Daten importieren

Zwar liegen die Daten auch auf meinem Rechner, aber für die geneigten Lesis ist es vermutlich einfacher, die Daten direkt vom RKI-Repo zu importieren.

Dafür müssen wir zuerst für jede Datei den Pfad vorne anfügen:

```{r}
vacc_path <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv"

vacc_time_files_w_path <-
  paste0(vacc_path, "/", vacc_time_files)
```


```{r}
head(vacc_time_files_w_path)
```


Könnte klappen...


Jetzt "mappen" wir auf jeden Dateinamen die Funktion `read_csv`:

```{r}
tic()
vacc_time_df <- 
  vacc_time_files_w_path %>% 
  map_df(read_csv)
toc()
```


Da das etwas Zeit kostet,
macht es vielleicht Sinn, den Datensatz lokal abzuspeichern.

```{r}
write_csv(vacc_time_df,
          file = "/Users/sebastiansaueruser/datasets/Covid/vacc_time_df.csv")
```


Halt, besser noch in diesem Repo,
damit die Daten für Sie einfach zugreifbar sind:

```{r}
write_csv(vacc_time_df,
          file = "static/datasets/vacc_time_df.csv")
```



# Daten joinen


Bringen wir H