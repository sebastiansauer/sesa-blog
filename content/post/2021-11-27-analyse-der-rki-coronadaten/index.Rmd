---
title: Analyse der RKI-Coronadaten
author: Sebastian Sauer
date: '2021-11-27'
slug: analyse-der-rki-coronadaten
categories:
  - rstats
tags:
  - covid19
  - tutorial
  - eda
  - regression
output:
  blogdown::html_page:
    toc: yes
    number_sections: yes
editor_options: 
  chunk_output_type: console
---


# Setup


```{r global-knitr-options, include=FALSE}
  knitr::opts_chunk$set(
  fig.pos = 'H',
  fig.asp = 0.618,
  fig.align='center',
  fig.width = 5,
  out.width = "100%",
  fig.cap = "", 
  #fig.path = "chunk-img/",
  dpi = 300,
  # tidy = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE,
  fig.show = "hold")
```

## R-Pakete

```{r include=FALSE}
library(rcrossref)  # zitieren
library(tidyverse)  # Datenjudo
library(rstatix)  # EDA-Komfort
library(forcats)  # Faktorvariablen sortieren
library(tictoc)  # Rechenzeit messen
library(gt)  # Tabellen im html
library(lubridate)  # Datumsangaben
library(ggrepel)  # Nicht überschneidende Labels
library(corrr)   # Korrelation, tidy
```



# Hintergrund

Die Corona-Epidemie beherrscht (wieder) die Nachrichten, Gespräche und Gedanken.
Zu Recht, aus zwei Gründen. 
Zum einen sind die Zahlen jetzt schon besorgniserregend, wenn nicht furchtbar.
Zum anderen haben [Pandemien das Potenzial zu krassen Extremwerten](https://www.nature.com/articles/s41567-020-0921-x?report=reader).

Dazu kommt, dass Falschmeldungen kursieren.
Schlimmer noch als reine Unwahrheit sind Halbwahrheiten.
Damit ist die Unsitte gemeint, einen einzelnen, (vielleicht) korrekten Fakt aufzugreifen,
und damit eine vielschichtige Forschungsfrage für beantwortet zu erklären.
Das gleicht dem Versuch, von einem 500-Teile-Puzzle ein Stück gefunden zu haben,
und nun zu reklamieren, man wisse, wie das ganze Puzzle aussieht.
Eher in Forschungsvokablen: Auf Basis einer Studie gibt man vor, 
eine Antwort auf eine breite Forschungsfrage zu geben,
ohne zu erwähnen, dass es noch 50 anders geartete Studien gibt,
die zu (evtl.) anderen Ergebnissen kommen.


Der Vergleich mehrerer Gruppen ist immer problematisch, 
problematisch in dem Maße, wie sich die Gruppen in unbekannter Weise unterscheiden.
So ist es beispielsweise schwierig, 
die Übersterblichkeit in Deutschland in 2020 und 2021 zu vergleichen.
Auf die Übersterblichkeit wirken viele Faktoren ein;
so könnten etwa die Kontaktbeschränkungen dazu geführt haben,
dass die Grippe sich nicht so ausbreiten konnte.
Dadurch wurden Krankheits- und Todesfälle vermieden;
man könnte aber auch (fälschlich) schlussfolgern,
dass Corona doch "nicht so schlimm" gewesen war.
Viele weitere Unterschiede sind denkbar;
etwas Deltavariante vs. den Ursprungsvirus und so weiter.

Der Vergleich zwischen Ländern ist aus dem gleichen Grund noch schwieriger.
Länder unterscheiden sich in vielen Hinsichten;
im Hinblick auf Corona sind vermutlich klimatorische Unterschiede entscheidend.
In einem warmen Land wird - bei gleicher Kontakt- oder Impfsituation -
sicherlich weniger Fälle auftreten als in einem kalten Land.
Das ist nur einer von vielen Unterschieden, 
die eine Rolle spielen können 
und uns zeigen,
warum die Menschen Experimente erfunden haben,
um die Vergleichbarkeit von Gruppen gewährleisten zu können.

Neben der Vergleichbarkeit der Daten spielt natürlich auch die Datenqualität
(neben und über die Vergleichbarkeit der Datenqualität hinaus) eine wichtige Rolle.
In Deutschland leistet das RKI gute Arbeit,
Daten auf möglichst hohem Niveau zu sammeln.
Praktischerweise sind diese Daten auch öffentlich und komfortabel zugänglich.

Im Lichte der bisher (in jüngerer Geschichte) nicht dagewesesen gesundheitlichen 
Gefährdungen durch die Epidemie und auch gesellschaftliche Brisanz ist die Frage
nach den Fakten zu Corona und ihren Auswirkungen von höchstem Belang.

Grund genug, sich die Daten und Analysen zu Corona auf *reproduzierbare* Art und Weise,
also transparent und für alle nachprüfbar, anzuschauen.


# Inzidenzen in Deutschland - Daten vom RKI

Das [Robert-Koch-Institut](https://www.rki.de/DE/Home/homepage_node.html) (RKI) stellt die Daten zu den Corona-Infektionen [hier](https://github.com/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland) öffentlich zum Herunerladen bereit.

Die [CSV-Datei mit den aktuellen Daten](https://github.com/robert-koch-institut/SARS-CoV-2_Infektionen_in_Deutschland/blob/master/Aktuell_Deutschland_SarsCov2_Infektionen.csv) ist groß; 150 MB (26.11.21).


Die Daten werden unter der [CC-BY-Lizenz bereitgestellt vom RKI.](https://github.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland#lizenz)



# Hospitalisierungen in Deutschland

Aufgrund der großen Dateigröße fangen wir mit einer kleineren Datei an.
[Die Datei mit den Hospitalisierungen](https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland) ist viel kleiner (3MB).

Es wird auch ein adjustierter Datensatz bereitgestellt:

>   Zwischen dem Beginn des Krankenhausaufenthalts eines COVID-19-Falles und dem Zeitpunkt, an dem diese Information am RKI eingeht, entsteht ein zeitlicher Verzug. Um den Trend der Anzahl von Hospitalisierungen und der 7-Tage-Hospitalisierungsinzidenz besser bewerten zu können, ergänzen wir die berichtete Hospitalisierungsinzidenz um eine Schätzung der zu erwartenden Anzahl an verzögert berichteten Hospitalisierungen. Neben den Daten der gemeldeten COVID-19-Hospitalisierungen auf Bundes- und Länderebene wird daher ein Nowcasting der Anzahl hospitalisierter Fälle und der 7-Tage-Hospitalisierungsinzidenz auf Bundesebene durchgeführt. Ziel ist die Schätzung der Anzahl von hospitalisierten COVID-19-Fällen mit Meldedatum innerhalb der sieben vorhergehenden Tage - inklusive der noch nicht an das RKI berichteten Hospitalisierungen.

Schauen wir uns den neuesten (adjustierten) Datensatz näher an.


Zur Berechnung der adjustierten 7T-Inzidenz schreibt das RKI [hier](https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland#berechnung-der-adjustierten-7-tage-hospitalisierungsinzidenz):

>   Die adjustierte 7-Tage-Hospitalisierungsinzidenz berechnet sich aus der adjustierten Anzahl der hospitalisierten COVID-19-Fälle der letzten sieben Tage (vorherig des Berichtsdatums) und der Bevölkerungszahl. Zur einheitlichen Darstellung wird die Inzidenz auf 100.000 Bevölkerung normiert.


## Adjustierte Daten

### Daten importieren


```{r}
hosp_file <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/master/Archiv/2021-11-24_Deutschland_adjustierte-COVID-19-Hospitalisierungen.csv"

hosp_adj <- read_csv(hosp_file)  # adj wie "adjustiert"
```


### EDA


```{r}
hosp_adj %>% 
  ggplot() +
  aes(x = Datum, y = PS_adjustierte_7T_Hospitalisierung_Inzidenz) +
  geom_line() 
```


## Unadjustierte Daten

### Daten importieren

```{r}
hosp_latest_file <- "https://github.com/robert-koch-institut/COVID-19-Hospitalisierungen_in_Deutschland/raw/master/Archiv/2021-11-27_Deutschland_COVID-19-Hospitalisierungen.csv"

hosp_latest <- read_csv(hosp_latest_file)
```


### EDA


#### Bundesgebiet

```{r}
hosp_latest %>% 
  filter(Bundesland == "Bundesgebiet") %>% 
  ggplot() +
  aes(x = Datum, y = `7T_Hospitalisierung_Inzidenz`) +
  geom_line(aes(color = Altersgruppe)) +
  scale_color_brewer(type = "qual")
```


#### Nach Bundesland


```{r}
hosp_latest %>% 
  filter(Bundesland != "Bundesgebiet") %>% 
  ggplot() +
  aes(x = Datum, y = `7T_Hospitalisierung_Inzidenz`) +
  geom_line(aes(color = Altersgruppe)) +
  scale_color_brewer(type = "qual") +
  facet_wrap(~ Bundesland)
```


```{r}
hosp_latest %>% 
  filter(Bundesland != "Bundesgebiet") %>% 
  filter(Datum == max(Datum)) %>% 
  select(-Bundesland_Id, -`7T_Hospitalisierung_Faelle`) %>% 
  mutate(Bundesland = factor(Bundesland)) %>% 
  group_by(Bundesland) %>% 
  summarise(Inz_7T_Hosp = mean(`7T_Hospitalisierung_Inzidenz`)) %>% 
  ggplot() +
  aes(y = fct_reorder(Bundesland, Inz_7T_Hosp), x = Inz_7T_Hosp) +
  geom_col()
```


#### Nach Datum


Erstellen wir ein paar weitere Variablen, die das Datum widerspiegeln:

```{r}
hosp_latest <-
hosp_latest %>% 
  mutate(Monat = month(Datum),
         Woche = week(Datum),
         Quartal = quarter(Datum),
         Jahr = year(Datum)) %>% 
  select(Datum, Monat, Woche, Quartal, Jahr, everything())
```


# Impfungen in Deutschland


## Neueste Daten

### Daten laden

Von [diesem Github-Repo](https://github.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland) kann man sich die Impfdaten beim RKI herunterladen.


Die Daten werden sogar pro Landkreis bereitgestellt.
Wir begnügen uns hier aber mit den Daten pro Bundesland.


```{r}
vacc_file_latest <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv/2021-11-27_Deutschland_Impfquoten_COVID-19.csv"

vacc_latest <- read_csv(vacc_file_latest)
```


```{r}
glimpse(vacc_latest)
```


Die Datei gibt die Impfquote für einen Tag (hier 27.11.21) wieder.

### EDA




```{r}
vacc_latest %>% 
  #filter(Bundesland != "Deutschland") %>% 
  mutate(Bundesland = factor(Bundesland)) %>% 
  ggplot() +
  aes(y = fct_reorder(Bundesland, Impfquote_gesamt_voll), 
      x = Impfquote_gesamt_voll) +
  geom_col() +
  labs(title = "Impfquote am 27.11.2021",
       caption = "Datenquelle: RKI")
```


Und hier als Vektor der Impfquoten (genauer gesagt: `Impfquote_gesamt_voll`), absteigend sortiert:

```{r}
vacc_latest_df <-
  vacc_latest %>% 
  filter(!Bundesland %in% c("Bundesressorts", "Deutschland")) %>% 
  mutate(Bundesland = factor(Bundesland)) %>% 
  select(Bundesland, Impfquote_gesamt_voll) %>% 
  arrange(-Impfquote_gesamt_voll)

vacc_latest_df %>%   
  gt() %>% 
  tab_options(
              heading.align = "left"
              )
```


Und wir speichern die Reihenfolge der Bundesländer nach Impfquote für spätere Verwendung in einem Vektor:


```{r}
bundeslaender_nach_impfquote <- 
  vacc_latest_df %>% 
  pull(Bundesland)

bundeslaender_nach_impfquote
```


## Impfquoten im Zeitverlauf



### Daten laden 1

```{r}
vacc_time_file <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv/2021-11-24_Deutschland_Bundeslaender_COVID-19-Impfungen.csv"

vacc_time <- read_csv(vacc_time_file)
```



```{r}
glimpse(vacc_time)
```

Diese Datei gibt uns nicht direkt die Impfquoten, sondern die Anzahl der Impfungen pro Bundesland pro Tag. 
Einfacher ist es vielleicht, die Dateien zu suchen, die uns die Impfquoten schon komfortabel zur Verfügung stellen.


### Daten laden 2

#### Relevante Daten finden

Im RKI-Repo finden sich dazu Dateien mit dem Namen `JJJJ-MM-TT_Deutschland_Impfquoten_COVID-19.csv`.

Unser Plan muss wohl sein, alle diese Dateien zusammenzutragen und dann in eine Tabelle (Dataframe) zusammenzufügen.

Da ich das Repo auf meine Festplatte heruntergeladen habe, 
kann ich recht komfortabel eine Liste der relevanten Dateien bekommen:

```{r}
vacc_dir <- "/Users/sebastiansaueruser/github-repos/COVID-19-Impfungen_in_Deutschland/Archiv"

search_term <- "^\\d{4}-\\d{2}-\\d{2}_Deutschland_Impfquoten_COVID-19.csv$"

vacc_time_files <- 
  list.files(path = vacc_dir,
             pattern = search_term)
```


```{r}
head(vacc_time_files)
length(vacc_time_files)
```

Wir haben also Daten von `r length(vacc_time_files)` Daten.


#### Daten importieren

Zwar liegen die Daten auch auf meinem Rechner, aber für die geneigten Lesis ist es vermutlich einfacher, die Daten direkt vom RKI-Repo zu importieren.

Dafür müssen wir zuerst für jede Datei den Pfad vorne anfügen:

```{r}
vacc_path <- "https://raw.githubusercontent.com/robert-koch-institut/COVID-19-Impfungen_in_Deutschland/master/Archiv"

vacc_time_files_w_path <-
  paste0(vacc_path, "/", vacc_time_files)
```


```{r}
head(vacc_time_files_w_path)
```


Könnte klappen...


Jetzt "mappen" wir auf jeden Dateinamen die Funktion `read_csv`:

```{r}
tic()
vacc_time_df <- 
  vacc_time_files_w_path %>% 
  map_df(read_csv)
toc()
```


Da das etwas Zeit kostet,
macht es vielleicht Sinn, den Datensatz lokal abzuspeichern.

```{r eval = FALSE}
write_csv(vacc_time_df,
          file = "/Users/sebastiansaueruser/datasets/Covid/vacc_time_df.csv")
```


Halt, besser noch in diesem Repo,
damit die Daten für Sie einfach zugreifbar sind:

```{r eval = FALSE}
write_csv(vacc_time_df,
          file = "static/datasets/vacc_time_df.csv")
```


Sie können [hier](https://raw.githubusercontent.com/sebastiansauer/sesa-blog/main/static/datasets/vacc_time_df.csv) die Daten herunterladen.


## EDA

### Impfquote Deutschland im Zeitverlauf

```{r}
vacc_time_df %>% 
  filter(Bundesland == "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll) +
  geom_line()
```


### Impfquote der Bundesländer im Zeitverlauf

```{r}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll) +
  geom_line() +
  facet_wrap(~ Bundesland, nrow = 4)
```

```{r}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll, color = Bundesland) +
  geom_line() +
  scale_color_viridis_d()
```


Die Daten reichen von ... bis ... :

```{r}
vacc_time_df %>% 
  filter(Datum == min(Datum)) %>% 
  pull(Datum)
```

```{r}
vacc_time_df %>% 
  filter(Datum == max(Datum)) %>% 
  pull(Datum)
```



Noch ein ganz nettes Detail:
Sortieren wir die Legende nach der Höhe der Impfquote.


Zuerst brauchen wir eine nach Impfquote geordnete Liste. 
Die haben wir oben schon mal erstellt:

```{r}
bundeslaender_nach_impfquote
```



```{r}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll, color = Bundesland) +
  geom_line() +
  scale_color_viridis_d(breaks = bundeslaender_nach_impfquote)
```


Häufig ist es sinnvoll, Liniendiagramme mit mehreren Linien gleich mit dem passenden Label zu versehen. 
Probieren wir das:


```{r fig.asp = 1}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll, color = Bundesland) +
  geom_line() +
  scale_color_viridis_d(breaks = NULL) +
  geom_label(data = vacc_time_df %>% filter(Datum == max(Datum)),
             aes(label = Bundesland))
```


Hm. Die Position der Labels ist nicht gut.
Versuchen wir, die Hälfte der Labels links im Diagramm, die andere Hälte rechts zu plotten.

Bestimmen wir dazu zuerst eine Hälfte an Bundesländern;
die, die wir links plotten:

```{r}
bl_links <- bundeslaender_nach_impfquote[c(2,4,6,8,10,12,14,16)]
bl_rechts <- setdiff(bundeslaender_nach_impfquote,
                     bl_links)
```

```{r}
bl_links
```

```{r}
bl_rechts
```

Jetzt bauen wir uns einen passenden Datensatz:

```{r}
vacc_time_labels <- 
  vacc_time_df %>% 
  filter(Datum == max(Datum)) %>% 
  mutate(bl_gruppe = case_when(
    Bundesland %in% bl_links ~ ymd("2021-09-16"),
    TRUE ~ ymd("2021-11-23")
  )) %>% 
  select(Bundesland, bl_gruppe, Impfquote_gesamt_voll)
```




```{r fig.asp = 1}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll, color = Bundesland) +
  geom_line() +
  scale_color_viridis_d(breaks = NULL) +
  geom_label(data = vacc_time_labels,
             aes(label = Bundesland,
                 x = bl_gruppe))
```

Sieht irgendwie  nicht so toll aus...


```{r}
vacc_time_df %>% 
  filter(Bundesland != "Deutschland") %>% 
  ggplot() +
  aes(x = Datum, y = Impfquote_gesamt_voll, color = Bundesland) +
  geom_line() +
  scale_color_viridis_d(breaks = NULL) +
  geom_label_repel(data = vacc_time_df %>% filter(Datum == max(Datum),
                                                  Bundesland != "Deutschland"),
             aes(label = Bundesland))
```


Hm, alles andere als perfekt. Aber lassen wir es damit gut sein und
wenden uns wichtigeren Themen zu.
Es ist allzu leicht, sich in (vielleicht ganz unterhaltsamen) Details zu verstricken.


# Daten joinen

"Verheiraten" wir die Daten zu Impfquoten und Hospitalisierungen.

Das geht mit einem `join`. 
Das Argument `by` gibt den "Schlüssel" (ID) an,
anhand dessen Zeilen aus den beiden Tabellen "verheiratet" werden.

[Hier](https://github.com/gadenbuie/tidyexplain#inner-join) findet sich eine gute visuelle Erklärung.

```{r}
hosp_vacc <- 
  hosp_latest %>% 
  inner_join(vacc_latest %>% select(-c(Bundesland, Datum)),
             by = c("Bundesland_Id" = "BundeslandId_Impfort"))
```


Beim `inner_join` werden nur Zeilen übernommen, 
für die es in beiden Tabellen eine Entsprechung (einen Wert für die ID-Variable) gibt.


# Zusammenhangsanalysen

Vielleicht ist der wichtigste Hinweis an dieser Stelle,
dass Beobachtungsdaten (also nicht von guten Experimenten stammend)
keine Aussagen über Kausaleinflüsse erlauben -
oder nur unter starken Annahmen.

## Zusammenhang von Impfquote und Hospitalisierung

### Im Zeitverlauf

Hier stellt sich die Frage, auf welchen Zeitrahmen wir aggregieren, 
um eine Korrelation zu berechnen?
Je kürzer der Zeitrahmen, desto instabiler die Schätzwerte.
Je länger der Zeitrahmen, desto mehr werden Veränderungen im Zeitverlauf unter den Teppich gekehrt.
In so einer Situation ist es vielleicht am besten, 
sich den Koeffizienten in hoher zeitlicher Auflösung anzuschauen,
um dann zu entscheiden, wie sehr man aggregieren kann.

```{r}
korr_vacc_hosp <- 
  hosp_vacc %>% 
  select(Jahr,
         Woche, Impfquote_gesamt_voll, 
         Inz_7T_Hosp = `7T_Hospitalisierung_Inzidenz`) %>% 
  filter(Jahr == 2021) %>% 
  group_by(Woche) %>% 
  summarise(Korr_Woche = cor(Impfquote_gesamt_voll,
                             Inz_7T_Hosp))
  
```


```{r}
korr_vacc_hosp_joined <- 
  korr_vacc_hosp %>% 
  left_join(hosp_vacc %>% select(Datum, Woche, Monat, Quartal)) %>% 
  group_by(Woche) %>% 
  filter(row_number() == 1)
```

#### Korrelation nach Woche

```{r}
korr_vacc_hosp_joined %>% 
  mutate(Quartal = factor(Quartal)) %>% 
  ggplot() +
  aes(y = Korr_Woche) +
  geom_rect(aes(
    x = NULL,
    y = NULL,
    xmin = Woche-1, 
    xmax = Woche, 
    ymin = -Inf,
    ymax = +Inf,
    fill = Quartal),
    alpha = .5) +
  scale_fill_manual(values = c("grey", "lightgreen", "darkgreen", "indianred4")) +
    geom_hline(yintercept = 0, color = "white", size = 2) +
  geom_point(alpha = .7, aes(x = Woche)) +
  geom_line(aes(x = Woche)) +
  labs(title = "Korrelation von Hospitalisierung und Impfquote pro Woche",
       caption = "Quartale des Jahres 2021 sind eingefärbt. Datenquelle: RKI",
       x = "Kalenderwoche 2021",
       y = "Korrelation (Wochenbasis)")
```


Die positive Korrelation im Sommer 2021 - je mehr Impfung, desto mehr Hospitalisierung - ist vor dem Hintergrund der extrem niedrigen Inzidenzzahlen in dieser Zeit zu sehen.




#### Korrelation nach Monat


```{r}
korr_vacc_hosp_monat <- 
  hosp_vacc %>% 
  select(Jahr,
         Monat, 
         Impfquote_gesamt_voll, 
         Inz_7T_Hosp = `7T_Hospitalisierung_Inzidenz`) %>% 
  filter(Jahr == 2021) %>% 
  group_by(Monat) %>% 
  summarise(Korr_Monat = cor(Impfquote_gesamt_voll,
                             Inz_7T_Hosp))
  
```

```{r}
korr_vacc_hosp_monat %>% 
  gt() %>% 
  fmt_number(2, decimals = 2)
```



```{r}
korr_vacc_hosp_monat_joined <- 
  korr_vacc_hosp_monat %>% 
  left_join(hosp_vacc %>% select(Datum, Monat, Quartal)) %>% 
  group_by(Monat) %>% 
  filter(row_number() == 1)
```


```{r}
korr_vacc_hosp_monat_joined %>% 
  mutate(Quartal = factor(Quartal)) %>% 
  ggplot() +
  aes(y = Korr_Monat) +
  geom_rect(aes(
    x = NULL,
    y = NULL,
    xmin = Monat-1, 
    xmax = Monat, 
    ymin = -Inf,
    ymax = +Inf,
    fill = Quartal),
    alpha = .5) +
  scale_fill_manual(values = c("grey", "lightgreen", "darkgreen", "indianred4")) +
    geom_hline(yintercept = 0, color = "white", size = 2) +
  geom_point(alpha = .7, aes(x = Monat)) +
  geom_line(aes(x = Monat)) +
  labs(title = "Korrelation von Hospitalisierung und Impfquote pro Monat",
       caption = "Quartale des Jahres 2021 sind eingefärbt. Datenquelle: RKI",
       x = "Kalenderwoche 2021",
       y = "Korrelation (Wochenbasis)")
```


Insgesamt ergibt sich ein ähnliches Bild,
wenn man noch Monat oder nach Woche aggregiert und dann die Korrelation jeweils berechnet.



### Korrelation nach Bundesland

#### November 2021

```{r}
hosp_vacc %>% 
  filter(Monat == 11, Bundesland != "Bundesgebiet") %>% 
  select(I = Impfquote_gesamt_voll,
         H = `7T_Hospitalisierung_Inzidenz`,
         B = Bundesland) %>% 
  group_by(B) %>% 
  summarise(I = mean(I),
            H = mean(H)) %>% 
  ggplot() +
  aes(x = I,
      y = H) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Impfquote (vollständig)",
       y = "7Tage-Hospitalisierungsquote",
       title = "Zusammenhang von Impfen und Hospitalisierung",
       subtitle = "Daten für November 2021, alle Altersgruppe",
       caption = "Datenquelle: RKI")
```


Fügen wir noch die Namen der Bundesländer zu den Punkten hinzu, aber vielleicht besser die Kurzform der Namen. 


```{r}
state_names <- 
  tibble::tribble(
    ~Bundesland, ~Kurzform,                          ~state,
    "Deutschland",      "DE",                       "Germany",
    "Baden-Württemberg",      "BW",             "Baden-Württemberg",
    "Bayern",      "BY",          "Bavaria (FreeState)",
    "Berlin",      "BE",                        "Berlin",
    "Brandenburg",      "BB",                   "Brandenburg",
    "Bremen",      "HB",       "Bremen (Hanseatic City)",
    "Hamburg",      "HH",      "Hamburg (Hanseatic City)",
    "Hessen",      "HE",                         "Hesse",
    "Mecklenburg-Vorpommern",      "MV", "Mecklenburg-Western Pomerania",
    "Niedersachsen",      "NI",                  "Lower Saxony",
    "Nordrhein-Westfalen",      "NW",        "North Rhine-Westphalia",
    "Rheinland-Pfalz",      "RP",          "Rhineland-Palatinate",
    "Saarland",      "SL",                      "Saarland",
    "Sachsen",      "SN",           "Saxony (Free tate)",
    "Sachsen-Anhalt",      "ST",                 "Saxony-Anhalt",
    "Schleswig-Holstein",      "SH",            "Schleswig-Holstein",
    "Thüringen",      "TH",        "Thuringia (Free State)",
    "Bundesgebiet",                "De", "Federal area"
  )

```


[Quelle](https://www.destatis.de/DE/Methoden/abkuerzung-bundeslaender-DE-EN.html)

Joinen wir die Kürzel der Bundesländer:

```{r}
hosp_vacc2 <- 
  hosp_vacc %>% 
  left_join(state_names)
```


```{r}
hosp_vacc_bundesland_nov <- 
hosp_vacc %>% 
  filter(Monat == 11, Bundesland != "Bundesgebiet") %>% 
  select(I = Impfquote_gesamt_voll,
         H = `7T_Hospitalisierung_Inzidenz`,
         Bundesland) %>% 
  group_by(Bundesland) %>% 
  summarise(I = mean(I),
            H = mean(H)) %>% 
  left_join(state_names)


hosp_vacc_bundesland_nov %>% 
  ggplot() +
  aes(x = I,
      y = H) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm") +
  labs(x = "Impfquote (vollständig)",
       y = "7Tage-Hospitalisierungsquote",
       title = "Zusammenhang von Impfen und Hospitalisierung",
       subtitle = "Daten für November 2021, alle Altersgruppe",
       caption = "Datenquelle: RKI") +
  geom_text(aes(label = Kurzform))
```


### Pro Quartal

Aggregieren wir den Dantesatz pro Quartal und pro Bundesland;:

```{r}
hosp_vacc_bundesland_pro_Quartal <- 
hosp_vacc %>% 
  filter(Bundesland != "Bundesgebiet") %>% 
  select(I = Impfquote_gesamt_voll,
         H = `7T_Hospitalisierung_Inzidenz`,
         Bundesland,
         Quartal) %>% 
  group_by(Bundesland, Quartal) %>% 
  summarise(I = mean(I),
            H = mean(H)) %>% 
  left_join(state_names)
```


Dann erstellen wir das letzte Diagramm, aber dieses Mal eines pro Quartal:

```{r}
Quartal_values <- c("1. Quartal", "2. Quartal",
                           "3. Quartal", "4. Quartal")
names(Quartal_values) <- c(1:4)


hosp_vacc_bundesland_pro_Quartal %>% 
  ggplot() +
  aes(x = I,
      y = H) +
  geom_point(alpha = .5) +
  geom_smooth(method = "lm") +
  labs(x = "Impfquote (vollständig)",
       y = "7Tage-Hospitalisierungsquote",
       title = "Zusammenhang von Impfen und Hospitalisierung",
       subtitle = "Aufgeteilt nach Quartale, aggregiert über alle Altersgruppe",
       caption = "Datenquelle: RKI") +
  geom_text(aes(label = Kurzform)) +
facet_wrap(~ Quartal, labeller = labeller(Quartal = Quartal_values))
````


Wir sehen, dass es im 3. Quartal in der Inzidenz kaum Streuung gibt, was die sehr geringe Korrelation erklärt.




